<?xml version="1.0"?>
<!--
license:CC0-1.0
-->
<mamelayout version="2">

<!-- define elements -->

	<element name="button" defstate="0">
		<!-- black border for the button -->
		<rect>
			<color red="0" green="0" blue="0"/>
			<bounds x="0" y="0" width="45" height="45"/>
		</rect>

		<!-- body -->
		<rect>
			<color state="0" red="0.16" green="0.18" blue="0.16"/>
			<color state="1" red="0.12" green="0.12" blue="0.12"/>
			<bounds x="3" y="3" width="39" height="39"/>
		</rect>
		<rect>
			<color state="0" red="0.5" green="0.5" blue="0.5"/>
			<color state="1" red="0.4" green="0.4" blue="0.4"/>
			<bounds x="3" y="3" width="1" height="39"/>
		</rect>
		<rect>
			<color state="0" red="0.2" green="0.2" blue="0.2"/>
			<color state="1" red="0.1" green="0.1" blue="0.1"/>
			<bounds x="3" y="42" width="39" height="1"/>
		</rect>

		<!-- a bit darker on the bottom -->
		<rect>
			<color red="0" green="0" blue="0" alpha="0.1"/>
			<bounds x="3" y="14" width="39" height="28"/>
		</rect>
		<rect>
			<color red="0" green="0" blue="0" alpha="0.1"/>
			<bounds x="3" y="21" width="39" height="21"/>
		</rect>
		<rect>
			<color red="0" green="0" blue="0" alpha="0.1"/>
			<bounds x="3" y="28" width="39" height="14"/>
		</rect>
		<rect>
			<color red="0" green="0" blue="0" alpha="0.1"/>
			<bounds x="3" y="35" width="39" height="7"/>
		</rect>
	</element>

	<element name="led" defstate="0">
		<disk>
			<color state="0" red="0.5" green="0.5" blue="0.16"/>
			<color state="1" red="1" green="1" blue="0"/>
		</disk>
	</element>

	<element name="knob_outer"><disk><color red="0.23" green="0.23" blue="0.24"/></disk></element>
	<element name="knob_value">
		<simplecounter maxstate="127" digits="1"><color red="1.0" green="1.0" blue="1.0"/></simplecounter>
	</element>
	<group name="knob">
		<element ref="knob_outer" id="knob_~knob_input~"><bounds x="0" y="0" width="40" height="40"/></element>
		<element ref="knob_value" inputtag="~knob_input~" inputmask="0xffff" inputraw="yes">
			<bounds x="3" y="7" width="34" height="24"/>
		</element>
	</group>


	<element name="rotating_knob">
		<disk>
			<color red="0.9" green="0.9" blue="1.0" alpha="0.05"/>
			<bounds x="0" y="0" width="47" height="47"/>
		</disk>

		<!-- For now ommit the tick. I'd like to animate it later using
		     currently unsupported element rotations with arbitrary angles:

		<rect>
		    <color red="0.6" green="0.6" blue="0.6"/>
		    <bounds x="22" y="2" width="3" height="12"/>
		</rect>
		-->

		<disk>
			<color red="0.42" green="0.38" blue="0.37"/>
			<bounds x="3" y="3" width="41" height="41"/>
		</disk>
	</element>

	<element name="gray_line">
		<rect>
			<color red="0.6" green="0.6" blue="0.6"/>
		</rect>
	</element>

	<element name="black_line">
		<rect>
			<color red="0" green="0" blue="0"/>
		</rect>
	</element>

	<element name="background_color">
		<rect>
			<color red="0.07" green="0" blue="0.18"/>
		</rect>
	</element>

	<element name="panel_sheet_hole">
		<image><data><![CDATA[
			<svg width="33" height="20">
				<!-- Must be the same color as "background_color" -->
				<rect x="0" y="0" width="33" height="20" rx="10" ry="10" fill="#12002e" />
			</svg>
		]]></data></image>
	</element>

	<element name="panel_sheet">
		<image><data><![CDATA[
			<svg width="1620" height="156">
				<rect x="0" y="0" width="1620" height="156" rx="7" ry="7" fill="#901210" />
			</svg>
		]]></data></image>
	</element>

	<element name="outlines">
		<image><data><![CDATA[
			<svg width="1700" height="180">
				<path stroke="none" fill="#1f1b18" d="
					m 967,23 c -6,0 -12,5 -12,12 v 7 106 c 0,6 5,12 12,12 h 594
					c 6,0 12,-5 12,-12 V 42 c 0,-6 -5,-12 -12,-12 h -463 -11
					c -5,0 -9,-3 -11,-7 z"/>
				</path>
			</svg>
		]]></data></image>
	</element>

	<element name="left_right_arrows">
		<image><data><![CDATA[
			<svg width="88" height="8">
				<path fill="#000000" stroke="none" d="
					m 88,4 -6.1,3.9 -0.1,-7.4 z
					m -88.2,0 6.1,3.9 0.1,-7.4 z"/>
			</svg>
		]]></data></image>
	</element>

	<element name="up_down_arrows">
		<image><data><![CDATA[
			<svg width="8" height="120">
				<path fill="#cccccc" stroke="none" d="
					m 4,0 4,6 -8,0 z
					m 0,120 4,-6 -8,-0 z"/>
			</svg>
		]]></data></image>
	</element>

	<element name="lines_for_knob_lables">
		<image><data><![CDATA[
			<svg width="46" height="117">
				<path fill="none" stroke="#666666" d="
					m 6.2,2.4 40,-2
					m 0,10 -37,10
					m -6,16 43,-16
					m -31,83 31,13
					m 0,-10 -41,-18
					m -5,-18 45,26
					m 0,-11 -45,-31"/>
			</svg>
		]]></data></image>
	</element>

	<element name="black_rect">
		<rect>
			<color red="0" green="0" blue="0"/>
		</rect>
	</element>

	<element name="screen_metalic_border"><!-- metalic frame around display -->
		<rect><color red="0.27" green="0.23" blue="0.23"/></rect>
	</element>

	<element name="screen_green_border"><!-- a portion of the display itself -->
		<rect><color red="0.56" green="0.95" blue="0"/></rect>
	</element>

	<element name="display_rect">
		<rect>
			<color red="0" green="0" blue="0" alpha="0.05"/>
		</rect>
	</element>

	<group name="the_display">
		<element ref="black_rect"><bounds x="0" y="0" width="255" height="82"/></element>
		<element ref="screen_metalic_border"><bounds x="6" y="2" width="243" height="78"/></element>
		<element ref="screen_green_border"><bounds x="20" y="15" width="215" height="53"/></element>
		<screen index="0"><bounds x="31" y="26" width="192" height="34"/></screen>
		<repeat count="2">
			<param name="y" start="25" increment="18" />
			<repeat count="16">
				<param name="x" start="31" increment="12" />
				<element ref="display_rect">
					<bounds x="~x~" y="~y~" width="10" height="16"/>
				</element>
			</repeat>
		</repeat>
	</group>

	<element name="access_logo_text"><text string="access"><color red="0" green="0" blue="0"/></text></element>
	<element name="virus_slogan_text"><text string="ADVANCED SIMULATED ANALOG SYNTHESIZER"><color red="0" green="0" blue="0"/></text></element>
	<element name="virus_logo_text">
		<text string="VIRUS">
			<bounds x="0" y="0" width="874" height="230"/>
			<color red="0.67" green="0.67" blue="0.67" alpha="0.33"/>
		</text>
	</element>
	<element name="rack_r_text"><text string="r"><color red="0.9" green="0.18" blue="0.18" alpha="0.19"/></text></element>
	<element name="rack_a_text"><text string="a"><color red="0.9" green="0.18" blue="0.18" alpha="0.19"/></text></element>
	<element name="rack_c_text"><text string="c"><color red="0.9" green="0.18" blue="0.18" alpha="0.19"/></text></element>
	<element name="rack_k_text"><text string="k"><color red="0.9" green="0.18" blue="0.18" alpha="0.19"/></text></element>

	<element name="input_text"><text string="INPUT"><color red="0" green="0" blue="0"/></text></element>
	<element name="phones_text"><text string="PHONES"><color red="0" green="0" blue="0"/></text></element>

	<element name="lfo_1_slash_text"><text string="LFO1/"><color red="0" green="0" blue="0"/></text></element>
	<element name="input_l_text"><text string="INPUT L"><color red="0" green="0" blue="0"/></text></element>
	<element name="lfo_2_slash_text"><text string="LFO2/"><color red="0" green="0" blue="0"/></text></element>
	<element name="input_r_text"><text string="INPUT R"><color red="0" green="0" blue="0"/></text></element>

	<element name="power_text"><text string="POWER"><color red="0" green="0" blue="0"/></text></element>
	<element name="store_text"><text string="STORE"><color red="0" green="0" blue="0"/></text></element>

	<element name="part_text"><text string="PART"><color red="0" green="0" blue="0"/></text></element>
	<element name="demo_text"><text string="DEMO"><color red="0" green="0" blue="0"/></text></element>

	<element name="multi_text"><text string="MULTI"><color red="0" green="0" blue="0"/></text></element>
	<element name="edit_black_text"><text string="EDIT"><color red="0" green="0" blue="0"/></text></element>

	<element name="single_text"><text string="SINGLE"><color red="0" green="0" blue="0"/></text></element>
	<element name="multisingle_text"><text string="MULTISINGLE"><color red="0" green="0" blue="0"/></text></element>

	<element name="parameter_text"><text string="PARAMETER"><color red="0" green="0" blue="0"/></text></element>
	<element name="bank_text"><text string="BANK"><color red="0" green="0" blue="0"/></text></element>

	<element name="minus_text"><text string="-"><color red="0" green="0" blue="0"/></text></element>
	<element name="value_black_text"><text string="VALUE"><color red="0" green="0" blue="0"/></text></element>
	<element name="plus_text"><text string="+"><color red="0" green="0" blue="0"/></text></element>
	<element name="program_text"><text string="PROGRAM"><color red="0" green="0" blue="0"/></text></element>

	<element name="osc_text"><text string="OSC"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="filt_text"><text string="FILT"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="env_text"><text string="ENV"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="lfo_text"><text string="LFO"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="efx_text"><text string="EFX"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="arpg_text"><text string="ARPG"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="edit_text"><text string="EDIT"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="slash_ctrl_text"><text string="/CTRL"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="value_text"><text string="VALUE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="attack_text"><text string="ATTACK"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="shape_text"><text string="SHAPE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="cutoff_text"><text string="CUTOFF"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="decay_text"><text string="DECAY"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="rate_text"><text string="RATE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="rev_time_slash_rate_text"><text string="REV TIME/RATE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="mode_text"><text string="MODE"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="wave_sel_slash_pw_text"><text string="WAVE SEL/PW"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="cutoff_2_text"><text string="CUTOFF2"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="sustain_text"><text string="SUSTAIN"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="damping_slash_depth_text"><text string="DAMPING/DEPTH"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="soft_knob_1_text"><text string="SOFT KNOB 1"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="octaves_text"><text string="OCTAVES"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="semitone_text"><text string="SEMITONE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="resonance_text"><text string="RESONANCE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="sus_time_text"><text string="SUS TIME"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="contour_text"><text string="CONTOUR"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="delay_text"><text string="DELAY"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="soft_knob_2_text"><text string="SOFT KNOB 2"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="pattern_text"><text string="PATTERN"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="detune_text"><text string="DETUNE"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="env_amount_text"><text string="ENV AMOUNT"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="release_text"><text string="RELEASE"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="key_follow_text"><text string="KEY FOLLOW"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="feedback_text"><text string="FEEDBACK"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="master_volume_text"><text string="MASTER VOLUME"><color red="0.8" green="0.8" blue="0.8"/></text></element>
	<element name="note_length_text"><text string="NOTE LENGTH"><color red="0.8" green="0.8" blue="0.8"/></text></element>

	<element name="jack">
		<image><data><![CDATA[
			<svg width="31" height="31">
				<circle fill="black" stroke="none" cx="15.5" cy="15.5" r="15.5" />
				<circle fill="none" stroke="#969a95" stroke-width="3" cx="15.5" cy="15.5" r="12.5" />
			</svg>
		]]></data></image>
	</element>


<!-- build layout -->

	<view name="Default Layout">
		<bounds x="25" y="0" width="1650" height="180"/>
		<element ref="background_color"><bounds x="0" y="0" width="1700" height="180"/></element>

		<element ref="panel_sheet"><bounds x="40" y="12" width="1620" height="156"/></element>
		<element ref="panel_sheet_hole"><bounds x="52" y="23" width="33" height="20"/></element>
		<element ref="panel_sheet_hole"><bounds x="52" y="137" width="33" height="20"/></element>
		<element ref="panel_sheet_hole"><bounds x="1614" y="23" width="33" height="20"/></element>
		<element ref="panel_sheet_hole"><bounds x="1614" y="137" width="33" height="20"/></element>

		<element ref="access_logo_text"><bounds x="47" y="79" width="79" height="28"/></element>
		<element ref="virus_logo_text"><bounds x="30" y="-25" width="874" height="230"/></element>
		<element ref="virus_slogan_text"><bounds x="1370" y="17" width="200" height="10"/></element>

		<element ref="jack"><bounds x="134" y="79" width="31" height="31"/></element>
		<element ref="input_text"><bounds x="131" y="112" width="36" height="12"/></element>

		<element ref="jack"><bounds x="195" y="79" width="31" height="31"/></element>
		<element ref="phones_text"><bounds x="189" y="112" width="43" height="12"/></element>

		<group ref="the_display"><bounds x="247" y="49" width="255" height="82"/></group>

		<element ref="lfo_1_slash_text"><bounds x="527" y="53" width="35" height="12"/></element>
		<element ref="input_l_text"><bounds x="527" y="65" width="51" height="12"/></element>
		<element ref="led" name="12.a"><!-- ? --><bounds x="584" y="59" width="11" height="11"/></element>

		<element ref="lfo_2_slash_text"><bounds x="527" y="108" width="35" height="12"/></element>
		<element ref="input_r_text"><bounds x="527" y="120" width="51" height="12"/></element>
		<element ref="led" name="12.a"><!-- ? --><bounds x="584" y="113" width="11" height="11"/></element>

		<element ref="power_text"><bounds x="613" y="26" width="35" height="12"/></element>
		<element ref="store_text"><bounds x="658" y="26" width="35" height="12"/></element>
		<element ref="button" inputtag="ROW5" inputmask="0x01"><!-- POWER --><bounds x="608" y="42" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x01"><!-- STORE --><bounds x="653" y="42" width="45" height="45"/></element>

		<element ref="button" inputtag="ROW5" inputmask="0x02"><!-- PART [<] --><bounds x="608" y="96" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x02"><!-- PART [>] --><bounds x="653" y="96" width="45" height="45"/></element>
		<element ref="part_text"><bounds x="638" y="146" width="30" height="12"/></element>
		<element ref="left_right_arrows"><bounds x="609" y="147" width="88" height="8"/></element>
		<element ref="demo_text"><bounds x="643" y="158" width="20" height="9"/></element>
		<element ref="black_line"><bounds x="611" y="161" width="29" height="1"/></element>
		<element ref="black_line"><bounds x="666" y="161" width="29" height="1"/></element>


		<element ref="multi_text"><bounds x="739" y="30" width="36" height="12"/></element>
		<element ref="edit_black_text"><bounds x="744" y="43" width="28" height="12"/></element>
		<element ref="led" name="14.6"><!-- 14 --><bounds x="752" y="59" width="11" height="11"/></element>

		<element ref="led" name="13.6"><!-- 22 --><bounds x="752" y="78" width="11" height="11"/></element>
		<element ref="led" name="13.5"><!-- 21 --><bounds x="796" y="78" width="11" height="11"/></element>
		<element ref="button" inputtag="ROW5" inputmask="0x04"><!-- MULTI --><bounds x="735" y="96" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x04"><!-- SINGLE --><bounds x="780" y="96" width="45" height="45"/></element>
		<element ref="multi_text"><bounds x="739" y="146" width="36" height="12"/></element>
		<element ref="single_text"><bounds x="781" y="146" width="42" height="12"/></element>
		<element ref="multisingle_text"><bounds x="754" y="158" width="54" height="9"/></element>
		<element ref="black_line"><bounds x="737" y="161" width="12" height="1"/></element>
		<element ref="black_line"><bounds x="811" y="161" width="12" height="1"/></element>

		<element ref="parameter_text"><bounds x="874" y="18" width="66" height="12"/></element>
		<element ref="left_right_arrows"><bounds x="863" y="19" width="88" height="8"/></element>
		<element ref="bank_text"><bounds x="897" y="30" width="20" height="9"/></element>
		<element ref="button" inputtag="ROW5" inputmask="0x08"><!-- PARAM [<] --><bounds x="863" y="42" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x08"><!-- PARAM [>] --><bounds x="908" y="42" width="45" height="45"/></element>

		<element ref="button" inputtag="ROW5" inputmask="0x10"><!-- VALUE [-] --><bounds x="863" y="96" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x10"><!-- VALUE [+] --><bounds x="908" y="96" width="45" height="45"/></element>
		<element ref="minus_text"><bounds x="865" y="148" width="10" height="12"/></element>
		<element ref="value_black_text"><bounds x="889" y="146" width="36" height="12"/></element>
		<element ref="plus_text"><bounds x="945" y="148" width="6" height="12"/></element>
		<element ref="program_text"><bounds x="890" y="158" width="34" height="9"/></element>

		<!-- NOTE:
		    The exact positioning of buttons is not very precise. Here I use non-zero values for x and y
		    just to get a resonable result (something that looks good, even though it is not precise).
		    Someday someone (myself, perhaps?!) should fine-tune this layout to more closely match the exact coordinates.
		-->
		<element ref="outlines"><bounds x="20" y="1" width="1700" height="180"/></element>
		<element ref="rack_r_text"><bounds x="1163" y="-10" width="61" height="190"/></element>
		<element ref="rack_a_text"><bounds x="1266" y="-10" width="55" height="190"/></element>
		<element ref="rack_c_text"><bounds x="1369" y="-10" width="51" height="190"/></element>
		<element ref="rack_k_text"><bounds x="1469" y="-10" width="59" height="190"/></element>

		<element ref="button" inputtag="ROW5" inputmask="0x20"><!-- EDIT UP --><bounds x="996" y="42" width="45" height="45"/></element>
		<element ref="button" inputtag="ROW6" inputmask="0x20"><!-- EDIT DOWN --><bounds x="996" y="96" width="45" height="45"/></element>
		<element ref="up_down_arrows"><bounds x="1015" y="32" width="8" height="120"/></element>

		<element ref="led" name="14.2"><!-- 10 --><bounds x="1056" y="33.0" width="11" height="11"/></element>
		<element ref="led" name="13.2"><!-- 18 --><bounds x="1056" y="50.5" width="11" height="11"/></element>
		<element ref="led" name="14.3"><!-- 11 --><bounds x="1056" y="68.0" width="11" height="11"/></element>
		<element ref="led" name="13.3"><!-- 19 --><bounds x="1056" y="85.5" width="11" height="11"/></element>
		<element ref="led" name="14.4"><!-- 12 --><bounds x="1056" y="103.0" width="11" height="11"/></element>
		<element ref="led" name="13.4"><!-- 20 --><bounds x="1056" y="120.5" width="11" height="11"/></element>
		<element ref="led" name="14.5"><!-- 13 --><bounds x="1056" y="138.0" width="11" height="11"/></element>

		<element ref="osc_text"><bounds x="1072" y="35" width="18" height="12"/></element>
		<element ref="filt_text"><bounds x="1072" y="52" width="23" height="12"/></element>
		<element ref="env_text"><bounds x="1072" y="69" width="16" height="12"/></element>
		<element ref="lfo_text"><bounds x="1072" y="86" width="16" height="12"/></element>
		<element ref="efx_text"><bounds x="1072" y="103" width="15" height="12"/></element>
		<element ref="edit_text"><bounds x="1072" y="121" width="20" height="12"/></element>
		<element ref="arpg_text"><bounds x="1072" y="136" width="28" height="12"/></element>
		<element ref="slash_ctrl_text"><bounds x="1077" y="148" width="30" height="9"/></element>


		<element ref="lines_for_knob_lables"><bounds x="1090" y="37" width="46" height="117"/></element>

		<!-- ENCODER A -->
		<element ref="value_text"><bounds x="1140" y="35" width="26" height="9"/></element>
		<element ref="value_text"><bounds x="1140" y="45" width="26" height="9"/></element>
		<element ref="attack_text"><bounds x="1137" y="55" width="32" height="9"/></element>

		<param name="knob_input" value="knob_0"/>
		<group ref="knob"><bounds x="1131" y="72" width="40" height="40"/></group>

		<element ref="value_text"><bounds x="1140" y="121" width="26" height="9"/></element>
		<element ref="value_text"><bounds x="1140" y="131" width="26" height="9"/></element>
		<element ref="value_text"><bounds x="1140" y="141" width="26" height="9"/></element>
		<element ref="value_text"><bounds x="1140" y="151" width="26" height="9"/></element>

		<!-- ENCODER B -->
		<element ref="shape_text"><bounds x="1239" y="35" width="25" height="9"/></element>
		<element ref="cutoff_text"><bounds x="1236" y="45" width="31" height="9"/></element>
		<element ref="decay_text"><bounds x="1238" y="55" width="26" height="9"/></element>

		<element ref="gray_line"><bounds x="1212" y="92" width="30" height="1"/></element>
		<element ref="led" name="13.1"><!-- 17 --><bounds x="1205" y="87" width="11" height="11"/></element>
		<param name="knob_input" value="knob_1"/>
		<group ref="knob"><bounds x="1231" y="72" width="40" height="40"/></group>

		<element ref="rate_text"><bounds x="1241" y="121" width="20" height="9"/></element>
		<element ref="rev_time_slash_rate_text"><bounds x="1218" y="131" width="68" height="9"/></element>
		<element ref="cutoff_text"><bounds x="1234" y="141" width="31" height="9"/></element>
		<element ref="mode_text"><bounds x="1241" y="151" width="20" height="9"/></element>

		<!-- ENCODER C -->
		<element ref="wave_sel_slash_pw_text"><bounds x="1321" y="35" width="58" height="9"/></element>
		<element ref="cutoff_2_text"><bounds x="1332" y="45" width="36" height="9"/></element>
		<element ref="sustain_text"><bounds x="1332" y="55" width="36" height="9"/></element>

		<element ref="gray_line"><bounds x="1312" y="92" width="30" height="1"/></element>
		<element ref="led" name="14.1"><!-- 9 --><bounds x="1305" y="87" width="11" height="11"/></element>
		<param name="knob_input" value="knob_2"/>
		<group ref="knob"><bounds x="1331" y="72" width="40" height="40"/></group>

		<element ref="shape_text"><bounds x="1338" y="121" width="25" height="9"/></element>
		<element ref="damping_slash_depth_text"><bounds x="1316" y="131" width="68" height="9"/></element>
		<element ref="soft_knob_1_text"><bounds x="1322" y="141" width="57" height="9"/></element>
		<element ref="octaves_text"><bounds x="1332" y="151" width="36" height="9"/></element>

		<!-- ENCODER D -->
		<element ref="semitone_text"><bounds x="1428" y="35" width="41" height="9"/></element>
		<element ref="resonance_text"><bounds x="1425" y="45" width="47" height="9"/></element>
		<element ref="sus_time_text"><bounds x="1428" y="55" width="41" height="9"/></element>

		<element ref="gray_line"><bounds x="1412" y="92" width="30" height="1"/></element>
		<element ref="led" name="13.0"><!-- 16 --><bounds x="1405" y="87" width="11" height="11"/></element>
		<param name="knob_input" value="knob_3"/>
		<group ref="knob"><bounds x="1431" y="72" width="40" height="40"/></group>

		<element ref="contour_text"><bounds x="1431" y="121" width="37" height="9"/></element>
		<element ref="delay_text"><bounds x="1436" y="131" width="26" height="9"/></element>
		<element ref="soft_knob_2_text"><bounds x="1420" y="141" width="58" height="9"/></element>
		<element ref="pattern_text"><bounds x="1431" y="151" width="36" height="9"/></element>

		<!-- ENCODER E -->
		<element ref="detune_text"><bounds x="1532" y="35" width="31" height="9"/></element>
		<element ref="env_amount_text"><bounds x="1522" y="45" width="52" height="9"/></element>
		<element ref="release_text"><bounds x="1530" y="55" width="36" height="9"/></element>

		<element ref="gray_line"><bounds x="1512" y="92" width="30" height="1"/></element>
		<element ref="led" name="14.0"><!-- 8 --><bounds x="1505" y="87" width="11" height="11"/></element>
		<param name="knob_input" value="knob_4"/>
		<group ref="knob"><bounds x="1531" y="72" width="40" height="40"/></group>

		<element ref="key_follow_text"><bounds x="1524" y="121" width="47" height="9"/></element>
		<element ref="feedback_text"><bounds x="1527" y="131" width="42" height="9"/></element>
		<element ref="master_volume_text"><bounds x="1513" y="141" width="68" height="9"/></element>
		<element ref="note_length_text"><bounds x="1519" y="151" width="58" height="9"/></element>
	</view>

	<script><![CDATA[
		file:set_resolve_tags_callback(
			function()
				local view = file.views["Default Layout"]
				install_slider_callbacks(view)

				for i = 0, 4 do
					local knob_input = "knob_" .. i
					add_knob(view, "knob_" .. knob_input, knob_input, 3.5, VERTICAL)
				end
			end)

		-----------------------------------------------------------------------
		-- Slider and knob library starts.
		-- Can be copied as-is to other layouts.
		-----------------------------------------------------------------------
		VERTICAL = 0
		HORIZONTAL = 1

		local widgets = {}   -- Stores slider and knob information.
		local pointers = {}  -- Tracks pointer state.

		-- The knob's Y position must be animated using <animate inputtag="{port_name}">.
		-- The click area's vertical size must exactly span the range of the
		-- knob's movement.
		function add_slider(view, clickarea_id, knob_id, port_name)
			table.insert(widgets, {
				clickarea   = get_layout_item(view, clickarea_id),
				slider_knob = get_layout_item(view, knob_id),
				field       = get_port_field(port_name),
				is_knob     = false })
		end

		-- A sweep between the attached field's min and max values requires
		-- moving the pointer by `scale * clickarea.height` pixes.
		function add_knob(view, clickarea_id, port_name, scale, drag_direction)
			table.insert(widgets, {
				clickarea     = get_layout_item(view, clickarea_id),
				field         = get_port_field(port_name),
				is_knob       = true,
				scale         = scale,
				is_horizontal = (drag_direction == HORIZONTAL) })
		end

		function get_layout_item(view, item_id)
			local item = view.items[item_id]
			if item == nil then
				emu.print_error("Layout element: '" .. item_id .. "' not found.")
			end
			return item
		end

		function get_port_field(port_name)
			local port = file.device:ioport(port_name)
			if port == nil then
				emu.print_error("Port: '" .. port_name .. "' not found.")
				return nil
			end
			local field = nil
			for k, val in pairs(port.fields) do
				field = val
				break
			end
			local field_msg = "Needs to either be an IPT_ADJUSTER, or an analog port with auto-center."
			if field == nil then
				emu.print_error("Port '" .. port_name .."' " .. field_msg)
				return nil
			end
			if field.is_analog and (not field.centerdelta or field.centerdelta == 0) then
				emu.print_error("Port '" .. port_name .."' " .. field_msg)
				return nil
			end
			return field
		end

		local function release_pointer(pointer_id)
			if pointers[pointer_id] then
				local field = widgets[pointers[pointer_id].selected_widget].field
				if field.is_analog then
					field:clear_value()
				end
			end
			pointers[pointer_id] = nil
		end

		local function pointer_updated(type, id, dev, x, y, btn, dn, up, cnt)
			-- If a button is not pressed, reset the state of the current pointer.
			if btn & 1 == 0 then
				release_pointer(id)
				return
			end

			-- If a button was just pressed, find the affected widget, if any.
			if dn & 1 ~= 0 then
				for i = 1, #widgets do
					local found, relative
					if widgets[i].slider_knob and widgets[i].slider_knob.bounds:includes(x, y) then
						found = true
						relative = true
					elseif widgets[i].clickarea.bounds:includes(x, y) then
						found = true
						relative = false
					end
					if found then
						pointers[id] = {
							selected_widget = i,
							relative = relative,
							start_x = x,
							start_y = y,
							start_value = widgets[i].field.port:read() }
						break
					end
				end
			end

			-- If there is no widget selected by the current pointer, we are done.
			if pointers[id] == nil then
				return
			end

			-- A widget is selected. Update its state based on the pointer's position.

			local pointer = pointers[id]
			local widget = widgets[pointer.selected_widget]

			local min_value = widget.field.minvalue
			local max_value = widget.field.maxvalue
			local value_range = max_value - min_value

			local new_value
			if widget.is_knob then
				if widget.is_horizontal then
					local step_x = value_range / (widget.scale * widget.clickarea.bounds.width)
					new_value = pointer.start_value + (x - pointer.start_x) * step_x
				else
					local step_y = value_range / (widget.scale * widget.clickarea.bounds.height)
					new_value = pointer.start_value + (pointer.start_y - y) * step_y
				end
			else
				local knob_half_height = widget.slider_knob.bounds.height / 2
				local min_y = widget.clickarea.bounds.y0 + knob_half_height
				local max_y = widget.clickarea.bounds.y1 - knob_half_height

				if pointer.relative then
					-- User clicked on the knob. The new value will depend on how
					--  much the knob was dragged.
					new_value = pointer.start_value - value_range * (y - pointer.start_y) / (max_y - min_y)
				else
					-- User clicked elsewhere on the slider. The new value will depend on
					-- the absolute position of the click.
					new_value = max_value - value_range * (y - min_y) / (max_y - min_y)
				end
			end

			new_value = math.floor(new_value + 0.5)
			if new_value < min_value then new_value = min_value end
			if new_value > max_value then new_value = max_value end

			if widget.field.is_analog then
				widget.field:set_value(new_value)
			else
				widget.field.user_value = new_value
			end
		end

		local function pointer_left(type, id, dev, x, y, up, cnt)
			release_pointer(id)
		end

		local function pointer_aborted(type, id, dev, x, y, up, cnt)
			release_pointer(id)
		end

		local function forget_pointers()
			for id, pointer in pairs(pointers) do
				release_pointer(id)
			end
			pointers = {}
		end

		function install_slider_callbacks(view)
			view:set_pointer_updated_callback(pointer_updated)
			view:set_pointer_left_callback(pointer_left)
			view:set_pointer_aborted_callback(pointer_aborted)
			view:set_forget_pointers_callback(forget_pointers)
		end
		-----------------------------------------------------------------------
		-- Slider and knob library ends.
		-----------------------------------------------------------------------
	]]></script>

</mamelayout>
