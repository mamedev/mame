#!/usr/bin/env python3
# license:BSD-3-Clause
# copyright-holders:Aleksey Gurtovoy

import argparse
import csv
import hashlib
import zlib
from pathlib import Path

SCRIPT_DIR = Path(__file__).resolve().parent
SCRIPT_NAME = Path(__file__).name

def file_info(path):
    data = Path(path).read_bytes()
    crc32 = zlib.crc32(data) & 0xFFFFFFFF
    sha1 = hashlib.sha1(data).hexdigest()
    return f"{len(data):#0x}", f"{crc32:08x}", sha1

def main(*, rom_path: Path, rom_mapping: str, header_name: str):
    print(f"Generating '{header_name}' using firmware in '{rom_path}' and '{rom_mapping}'... ", end="")

    rom_table_prefix = header_name.split(".")[0].upper()
    with open(SCRIPT_DIR / header_name, "w") as out:
        out.write(f"""// Auto-generated by `{SCRIPT_NAME}`, do not edit directly\n
#define {rom_table_prefix}_TABLE(ROM_BLOCK) \\
""")

        with open(rom_path / rom_mapping, "r") as cvs_rom_mapping:
            mapping = csv.reader(cvs_rom_mapping)
            for offset, filename in mapping:
                # skip `lockout.bin` workaround
                if (offset == "3f" and filename == "lockout.bin"):
                    continue

                size, crc, sha1 = file_info(rom_path / filename)
                filename_arg = f"\"{filename}\","
                out.write(f"    ROM_BLOCK(0x{offset}, {filename_arg:<28} {size}, CRC({crc}), SHA1({sha1})) \\\n")

        out.write("/**/\n")

    print("Done.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Generates a ROM header from the specified firmware files")
    parser.add_argument("rom_path", type=Path, help="A path to the firmware dir")

    default_header_name = "f256k_rom.h"
    parser.add_argument("-n", "--header-name", help=f"Header name, defaults to '{default_header_name}'", default=default_header_name)

    default_csv_mapping = "bulk.csv"
    parser.add_argument("-m", "--rom-mapping", help=f"A CSV file mapping ROM offsets to filenames, defaults to '{default_csv_mapping}'", default=default_csv_mapping)

    args = parser.parse_args()
    main(rom_mapping=args.rom_mapping, rom_path=args.rom_path, header_name=args.header_name)
