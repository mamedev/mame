#!/usr/bin/env python3
"""Analyze D-RAM slot details including MIX and SRAM addresses."""

# D-RAM data for all slots (extracted earlier)
dram = {
    0: [0x00000, 0x00001, 0x40000, 0x40000, 0x00080, 0x00000, 0x00000, 0x00000,
        0x57FFF, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    1: [0x00000, 0x00001, 0x00000, 0x40000, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    2: [0x00000, 0x00001, 0x40000, 0x40201, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    3: [0x00000, 0x00001, 0x00000, 0x40201, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    4: [0x00000, 0x50080, 0x00400, 0x40000, 0x00080, 0x00000, 0x7FFFF, 0x40402,
        0x00100, 0x00080, 0x00180, 0x0007C, 0x00000, 0x00000, 0x00000, 0x34080],
    5: [0x00080, 0x00180, 0x1003F, 0x10000, 0x00100, 0x00100, 0x3FF00, 0x6DF00,
        0x5A100, 0x40402, 0x40402, 0x40402, 0x40402, 0x00000, 0x40000, 0x3C280],
    6: [0x5F000, 0x7FC80, 0x00600, 0x00080, 0x00380, 0x00000, 0x00000, 0x52C00,
        0x2D430, 0x00400, 0x7FC00, 0x00000, 0x34000, 0x00000, 0x00000, 0x00680],
    7: [0x2B800, 0x7FE80, 0x00400, 0x00080, 0x00180, 0x6667F, 0x79999, 0x7F800,
        0x7FF00, 0x00000, 0x40000, 0x00000, 0x7F880, 0x00000, 0x00000, 0x3C480],
    8: [0x23500, 0x7FF80, 0x00200, 0x00080, 0x00180, 0x66A7F, 0x79A9F, 0x7F800,
        0x7FF00, 0x00000, 0x40000, 0x00000, 0x7F880, 0x00000, 0x00000, 0x3C480],
    9: [0x1AE00, 0x7FE80, 0x00200, 0x00080, 0x00180, 0x66EBF, 0x79BA5, 0x7F800,
        0x7FF00, 0x00000, 0x40000, 0x00000, 0x7F880, 0x00000, 0x00000, 0x3C480],
    10:[0x0F700, 0x7FF80, 0x00000, 0x00080, 0x00180, 0x674BF, 0x79D2F, 0x7F800,
        0x7FF00, 0x00000, 0x40000, 0x00000, 0x7F880, 0x00000, 0x00000, 0x3C480],
    11:[0x08C00, 0x7FE80, 0x00000, 0x00080, 0x00180, 0x677FF, 0x79DF3, 0x7F800,
        0x7FF00, 0x00000, 0x40000, 0x00000, 0x7F880, 0x00000, 0x00000, 0x3C480],
    12:[0x00000, 0x00001, 0x40000, 0x40C06, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    13:[0x00000, 0x00001, 0x00000, 0x40C06, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    14:[0x00000, 0x00001, 0x40000, 0x40E07, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
    15:[0x00000, 0x00001, 0x00000, 0x40E07, 0x00080, 0x00000, 0x00000, 0x00000,
        0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00000, 0x00800],
}

def decode_word15(val):
    """Decode word 15 configuration."""
    idle = (val >> 11) & 1
    alg = (val >> 8) & 7
    return idle, alg

def decode_amp_mix(val):
    """Decode amplitude and mix from a D-RAM word.
    Format: | AMP (12 bits) | X | MIXL (3) | MIXR (3) | X |
    """
    amp = (val >> 7) & 0xFFF  # bits 18:7
    mixl = (val >> 4) & 0x7   # bits 6:4
    mixr = (val >> 1) & 0x7   # bits 3:1
    return amp, mixl, mixr

mix_atten = {
    0: "mute",
    1: "-36dB",
    2: "-30dB",
    3: "-24dB",
    4: "-18dB",
    5: "-12dB",
    6: "-6dB",
    7: "0dB"
}

print("=" * 70)
print("Word 15 Configuration (IDLE/ALG)")
print("=" * 70)
for slot in range(16):
    w15 = dram[slot][15]
    idle, alg = decode_word15(w15)
    status = "IDLE" if idle else "ACTIVE"
    print(f"Slot {slot:2d}: 0x{w15:05X} -> {status}, ALG={alg}")

print("\n" + "=" * 70)
print("IDLE Slots D-RAM Analysis")
print("=" * 70)

idle_slots = [0,1,2,3,12,13,14,15]
for slot in idle_slots:
    print(f"\nSlot {slot} (IDLE):")
    for i, val in enumerate(dram[slot]):
        if val != 0:
            print(f"  word[{i:2d}] = 0x{val:05X}")
            # Check if this could be SRAM address (wave format)
            if val & 0x40000:  # bit 18 set = internal wave
                wave_type = (val >> 10) & 0xFF
                print(f"           -> Internal wave, type=0x{wave_type:02X}")
            elif val > 0x100:  # Could be external address
                print(f"           -> Possibly external SRAM addr or config")

print("\n" + "=" * 70)
print("MIX Settings Analysis (word with MIXL/MIXR)")
print("=" * 70)

# For ALG 4 (slots 7-11), MIX is updated from D[5] at PC07 (WXY WSP)
# For ALG 6 (slot 6), MIX is updated from D[7] at PC05 (WXY WSP)

print("\nSlots 7-11 (ALG 4) - MIX from word[5]:")
for slot in [7,8,9,10,11]:
    val = dram[slot][5]
    amp, mixl, mixr = decode_amp_mix(val)
    print(f"  Slot {slot}: 0x{val:05X} -> AMP=0x{amp:03X}, MIXL={mix_atten[mixl]}, MIXR={mix_atten[mixr]}")

print("\nSlot 6 (ALG 6) - MIX from word[7]:")
val = dram[6][7]
amp, mixl, mixr = decode_amp_mix(val)
print(f"  Slot 6: 0x{val:05X} -> AMP=0x{amp:03X}, MIXL={mix_atten[mixl]}, MIXR={mix_atten[mixr]}")

print("\n" + "=" * 70)
print("SRAM Address Pattern in word[3] (idle slots)")
print("=" * 70)

for slot in idle_slots:
    val = dram[slot][3]
    print(f"Slot {slot:2d}: word[3] = 0x{val:05X}")
    # Bits 18:10 might be wave/address, bits 9:0 might be something else
    upper = (val >> 10) & 0x1FF
    lower = val & 0x3FF
    print(f"         upper 9 bits = 0x{upper:03X}, lower 10 bits = 0x{lower:03X}")
